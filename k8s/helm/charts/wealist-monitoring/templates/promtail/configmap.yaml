{{- if .Values.promtail.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: {{ .Values.global.namespace }}
  labels:
    app: promtail
    app.kubernetes.io/name: promtail
    app.kubernetes.io/component: logging
data:
  promtail-config.yaml: |
    # =============================================================================
    # Promtail Configuration for weAlist (Kubernetes)
    # =============================================================================
    # Kubernetes Pod 로그를 수집하여 Loki로 전송

    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: {{ .Values.promtail.config.lokiUrl }}

    scrape_configs:
      # Kubernetes Pod 로그 수집
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ .Values.global.namespace }}

        relabel_configs:
          # Pod 이름을 라벨로 추가
          - source_labels: ['__meta_kubernetes_pod_name']
            target_label: 'pod'

          # 네임스페이스 라벨 추가
          - source_labels: ['__meta_kubernetes_namespace']
            target_label: 'namespace'

          # 컨테이너 이름 라벨 추가
          - source_labels: ['__meta_kubernetes_pod_container_name']
            target_label: 'container'

          # App 라벨 추가 (서비스 구분용)
          - source_labels: ['__meta_kubernetes_pod_label_app']
            target_label: 'app'

          # 서비스명 추출
          - source_labels: ['__meta_kubernetes_pod_label_app_kubernetes_io_name']
            target_label: 'service'

          # 로그 파일 경로 설정
          - source_labels: ['__meta_kubernetes_pod_uid', '__meta_kubernetes_pod_container_name']
            target_label: '__path__'
            separator: /
            replacement: /var/log/pods/*$1/$2/*.log

        pipeline_stages:
          # CRI 컨테이너 런타임 로그 포맷 파싱 (Kind uses containerd)
          # Format: 2024-01-01T00:00:00.000000000Z stdout F <actual log>
          - cri: {}

          # JSON 로그 파싱 시도 (Go 서비스들은 zap JSON 로그 출력)
          # JSON이 아닌 로그는 그대로 유지됨
          - match:
              selector: '{app=~".+"}'
              stages:
                - json:
                    expressions:
                      level: level
                      message: msg
                      timestamp: ts
                      error: error
                      caller: caller
                - labels:
                    level:
{{- end }}
